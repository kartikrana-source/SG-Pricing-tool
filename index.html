<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Internal Pricing Tool</title>

<style>

* {
    box-sizing: border-box;
}

body {
    font-family: "Segoe UI", sans-serif;
    margin: 0;
    padding: 40px;
    background: #f5f7fb;
}

/* ===== Card Container ===== */
.container {
    max-width: 1200px;
    margin: auto;
    background: white;
    padding: 30px;
    border-radius: 12px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.08);
}

h2 {
    margin-top: 0;
    margin-bottom: 25px;
    font-weight: 600;
    color: #222;
}

/* ===== Form ===== */
.form-row {
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
    margin-bottom: 20px;
}

input {
    padding: 10px 12px;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-size: 14px;
    width: 280px;
    transition: 0.2s ease;
}

input:focus {
    outline: none;
    border-color: #4f46e5;
    box-shadow: 0 0 0 3px rgba(79,70,229,0.15);
}

/* ===== Buttons ===== */
button {
    padding: 10px 16px;
    border: none;
    border-radius: 6px;
    font-size: 14px;
    cursor: pointer;
    font-weight: 500;
    transition: 0.2s ease;
}

.primary-btn {
    background: linear-gradient(90deg, #4f46e5, #6366f1);
    color: white;
}

.primary-btn:hover {
    opacity: 0.9;
}

.secondary-btn {
    background: #e5e7eb;
}

.secondary-btn:hover {
    background: #d1d5db;
}

/* ===== Loader ===== */
#loader {
    margin-top: 15px;
    font-weight: 500;
    color: #4f46e5;
}

/* ===== Debug ===== */
.debug-info {
    margin-top: 20px;
    padding: 15px;
    background: #fef9c3;
    border-radius: 6px;
    font-size: 14px;
}

/* ===== JSON Output ===== */
.json-container {
    margin-top: 25px;
    background: #ffffff;
    border-radius: 8px;
    padding: 20px;
    border: 1px solid #e5e7eb;
    max-height: 600px;
    overflow: auto;
    font-family: monospace;
    font-size: 13px;
    line-height: 1.6;
}

/* Syntax Highlighting */
.key {
    color: #dc2626; /* Red */
    font-weight: 600;
}

.string {
    color: #2563eb; /* Blue */
}

.number {
    color: #2563eb;
}

.boolean {
    color: #2563eb;
}

.null {
    color: #9ca3af;
}

</style>
</head>

<body>

<div class="container">

<h2>Internal Pricing Tool</h2>

<div class="form-row">
    <input type="text" id="outletCode" placeholder="Enter Outlet Code">
    <button class="primary-btn" onclick="fetchData()">Fetch Pricing</button>
    <button class="secondary-btn" onclick="copyJson()">Copy JSON</button>
</div>

<div id="loader" style="display:none;">Loading data...</div>
<div id="debugInfo" class="debug-info" style="display:none;"></div>
<div id="jsonOutput" class="json-container"></div>

</div>

<script>

const BASE_PRICE_API =
"https://demo.salescode.ai/productmetadata/v1/items/pricing?size=10000&page=0&appType=pwa&appVersion=10000.1.0&source=app";

const PRODUCT_API =
"https://demo.salescode.ai/products?size=10000&page=0&minimalResponse=true&filter=activeStatus:active&appType=pwa&appVersion=10000.1.0&source=app";


function syntaxHighlight(json) {
    json = JSON.stringify(json, null, 2);
    json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|\b\d+\b)/g, function (match) {
        let cls = 'number';
        if (/^"/.test(match)) {
            if (/:$/.test(match)) {
                cls = 'key';
            } else {
                cls = 'string';
            }
        } else if (/true|false/.test(match)) {
            cls = 'boolean';
        } else if (/null/.test(match)) {
            cls = 'null';
        }
        return '<span class="' + cls + '">' + match + '</span>';
    });
}


function extractArray(data) {
    if (!data) return [];
    if (Array.isArray(data)) return data;
    if (Array.isArray(data.features)) return data.features;

    const wrappers = ['content','data','items','results','products','pricing','records'];
    for (const key of wrappers) {
        if (Array.isArray(data[key])) return data[key];
    }
    return [];
}

function buildMap(arr) {
    const map = {};
    arr.forEach(item => {
        const sku = String(item.skuCode || item.batchCode || item.id || '').trim();
        if (sku) map[sku] = item;
    });
    return map;
}

async function fetchData() {

    const outletCode = document.getElementById("outletCode").value.trim();

    if (!outletCode) {
        alert("Please enter outlet code.");
        return;
    }

    document.getElementById("loader").style.display = "block";
    document.getElementById("jsonOutput").innerHTML = "";
    document.getElementById("debugInfo").style.display = "none";

    const PRICING_ADJUSTMENT_API =
        `https://demo.salescode.ai/v1/getPricingConditions/${outletCode}?appType=pwa&appVersion=10000.1.0&source=app`;

    try {
        const signinRes = await fetch("/api/proxy?action=signin", { method: "POST" });
        const signinData = await signinRes.json();
        const token = signinData?.token;

        if (!signinRes.ok || !token) {
            throw new Error("Signin failed. Unable to fetch token.");
        }

        const headers = { "Authorization": `Bearer ${token}` };

        const [productRes, basePriceRes, adjustmentRes] = await Promise.all([
            fetch(`/api/proxy?url=${encodeURIComponent(PRODUCT_API)}`, { headers }),
            fetch(`/api/proxy?url=${encodeURIComponent(BASE_PRICE_API)}`, { headers }),
            fetch(`/api/proxy?url=${encodeURIComponent(PRICING_ADJUSTMENT_API)}`, { headers })
        ]);

        if (!productRes.ok || !basePriceRes.ok || !adjustmentRes.ok) {
            throw new Error("Failed to fetch one or more pricing endpoints.");
        }

        const products = extractArray(await productRes.json());
        const prices = extractArray(await basePriceRes.json());
        const adjustments = extractArray(await adjustmentRes.json());

        const productMap = buildMap(products);
        const priceMap = buildMap(prices);
        const adjustmentMap = buildMap(adjustments);

        const finalResult = Object.keys(priceMap).map(sku => ({
            skuCode: sku,
            productMetadata: productMap[sku] || null,
            basePricing: priceMap[sku],
            adjustment: adjustmentMap[sku] || null
        }));

        document.getElementById("jsonOutput").innerHTML =
            syntaxHighlight(finalResult);

        document.getElementById("debugInfo").textContent =
            `Products: ${products.length} | Base Prices: ${prices.length} | Adjustments: ${adjustments.length}`;

        document.getElementById("debugInfo").style.display = "block";

    } catch (error) {
        document.getElementById("jsonOutput").innerHTML =
            `<span style="color:red;">Error: ${error.message}</span>`;
    }

    document.getElementById("loader").style.display = "none";
}

function copyJson() {
    const text = document.getElementById("jsonOutput").innerText;
    navigator.clipboard.writeText(text);
    alert("Copied!");
}

</script>

</body>
</html>
